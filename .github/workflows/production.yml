name: Deploy Laravel (SFTP - Testing)

on:
  push:
    branches: [production]

env:
  PHP_VERSION: "8.2"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, mysql

      - name: Install dependencies
        run: composer install --no-dev --optimize-autoloader

      # - name: Run tests
      #   run: ./vendor/bin/phpunit --configuration phpunit.xml
      #   continue-on-error: true

      - name: Create deployment archive
        run: |
          mkdir -p build
          rsync -av --exclude='.git' \
                    --exclude='node_modules' \
                    --exclude='tests' \
                    --exclude='.env' \
                    --exclude='vendor' \
                    --exclude='build' \
                    ./ build/
          cd build
          tar -czf ../deploy.tar.gz .

      - name: Upload via SFTP (to public_html)
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          username: ${{ secrets.SSH_USER }}
          server: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          ssh_private_key: ${{ secrets.SSH_KEY }}
          local_path: "./deploy.tar.gz"
          remote_path: "/home/CAGLOBALS/web/testing.caglobals.com/public_html/"
          sftp_only: true
          create_remote_dir: true

      - name: Extract in public_html
        uses: appleboy/ssh-action@v1.0.0
        with:
          username: ${{ secrets.SSH_USER }}
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/CAGLOBALS/web/testing.caglobals.com/public_html

            # Extract files
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz

            # Restore environment file
            cp /home/CAGLOBALS/web/testing.caglobals.com/shared/.env .env

            # Ensure storage link exists
            php artisan storage:link || true

            # Laravel optimizations
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "Testing deployment completed."
